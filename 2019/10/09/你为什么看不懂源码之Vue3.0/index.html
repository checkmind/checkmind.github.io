<!DOCTYPE html>
<html lang=>
  <head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <meta name="description" content>
  <meta name="keywords" content>
  
    <link rel="icon" href>
  
    
  <title>你为什么看不懂源码之Vue 3.0 | qqqdu&#39;s blog</title>
  <link rel="stylesheet" href="/style.css">
  <link rel="stylesheet" href="/lib/jquery.fancybox.min.css">
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
</head>

<body>
  <header>
  <div class="header-container">
    <a class='logo' href="/">
      <span>qqqdu's blog</span>
    </a>
    <ul class="right-header">
      
        <li class="nav-item">
          
            <a href="/" class="item-link">首页</a>
          
        </li>
      
        <li class="nav-item">
          
            <a href="/about" class="item-link">关于</a>
          
        </li>
      
        <li class="nav-item">
          
            <a href="/archives" class="item-link">归档</a>
          
        </li>
      
        <li class="nav-item">
          
            <a href="/tags" class="item-link">标签</a>
          
        </li>
      
    </ul>
  </div>
</header>

  <main id='post'>
  <div class="content">
    <article>
        <section class="content markdown-body">
          <h1>你为什么看不懂源码之Vue 3.0</h1>
          <div class='post-meta'>
            <i class="fa fa-calendar" aria-hidden="true"></i> <time>2019/10/09</time>
            
            
          </div>
          <p>很早之前就想写这一篇  </p>
<h2 id="先唠会儿嗑"><a href="#先唠会儿嗑" class="headerlink" title="先唠会儿嗑"></a>先唠会儿嗑</h2><p>记得很早之前，有个人说过，看源码就像武侠小说里的 学习武林秘籍。会耍刀耍剑那是外力，学习武功秘籍才是内力，才能和别人在对波或战前拼气时更升一筹。<br>在实际开发中，想象这样一个场景：  </p>
<blockquote>
<ul>
<li>小A：我这儿遇到一个bug，不知道是不是浏览器兼容？也可能是网络问题？会不会是框架问题！  </li>
</ul>
</blockquote>
<blockquote>
<ul>
<li>你：（轻蔑的一瞥），这块儿呀，我之前撸过它的源码，是XX导致了XX，让你这块儿代码产生了XX的影响。（讲完后背着手头也不回的去接杯咖啡。）  </li>
</ul>
</blockquote>
<p>这多装逼呀！  </p>
<h2 id="现实总不如意"><a href="#现实总不如意" class="headerlink" title="现实总不如意"></a>现实总不如意</h2><p>读框架的源码的确可以装以上的逼，但……</p>
<p>每当你看源码时，就像初中时听数学课，几分钟前兴致盎然，低头捡根笔，再抬头时已 “物是人非”，源码仿佛变成质能方程，数学老师仿佛变成没有胡子的 爱因斯坦 ？？！  </p>
<p>你看到一个个大V发出来的源码解读文章，为什么别人能看懂？  </p>
<p>你可能会想：是不是我太笨？是不是源码太难懂？是不是我不适合这一行……  </p>
<p>别担心，99%的人和你一样。  </p>
<p>那些大V只告诉你读源码时的过程，却没有告诉你读源码前的准备。  </p>
<p>而我会从读源码的准备阶段讲起。</p>
<h2 id="磨刀不误砍柴工"><a href="#磨刀不误砍柴工" class="headerlink" title="磨刀不误砍柴工"></a>磨刀不误砍柴工</h2><p>读源码前，你的基础功一定要扎实。<br>比如以下两个方法：<br><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> isObject = <span class="function">(<span class="params">val: <span class="built_in">any</span></span>) =&gt;</span></span><br><span class="line">  val !== <span class="literal">null</span> &amp;&amp; <span class="keyword">typeof</span> val === <span class="string">'object'</span></span><br></pre></td></tr></table></figure></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> isObject = <span class="function">(<span class="params">val: <span class="built_in">any</span></span>) =&gt;</span></span><br><span class="line">  val !== <span class="literal">null</span> &amp;&amp; <span class="built_in">Object</span>.prototype.toString.call(cal) === <span class="string">'[object Object]'</span></span><br></pre></td></tr></table></figure>
<p>同样的函数名，但功能不同，如果你了解 <code>typeof</code> 并且了解原型方法 <code>toString</code> 以及 <code>call</code> 的作用，那你很容易分辨出来这两者的区别和作用。  </p>
<p>当你看源码时，扫一眼函数体，便知道框架作者要做什么。  </p>
<p>你可能会问我，基础功不行怎么看源码？  </p>
<p>emmmm 我的建议是别看了。先磨刀吧。因为你当前阶段提升的最快方法是学习基础知识。</p>
<h2 id="预知此事先躬行"><a href="#预知此事先躬行" class="headerlink" title="预知此事先躬行"></a>预知此事先躬行</h2><blockquote>
<p>小A：我基础功练好了，可以看源码了吧？  </p>
</blockquote>
<blockquote>
<p>我：可以看，也不能看。  </p>
</blockquote>
<blockquote>
<p>小A：你在逗我？  </p>
</blockquote>
<p> 不是的，可以看的意思是，我们先大体扫一边源码，这个过程小于 5分钟。看看源码作者用了什么新鲜的api 或老的你没见过的api。  </p>
<p> 现在我们需要把 vue 3.0的源码clone下来，享受这短暂的五分钟。  </p>
<p> 可以看到，vue 3.0 用了大量的  </p>
<p> <code>Reflect\Proxy\Symbol\Map\Set</code>  </p>
<p> 你得确保这些api你都了如指掌，如果你做不到了如指掌，也得知道它们分别是干什么的。<br> 在这篇文章里我不会给你一一列举它们的功能，我只告诉你读源码前的准备。希望你能自己理解，而不是拾人牙慧。  </p>
<p> <a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects" target="_blank" rel="noopener">文档</a></p>
<h2 id="要拾人牙慧"><a href="#要拾人牙慧" class="headerlink" title="要拾人牙慧"></a>要拾人牙慧</h2><blockquote>
<p>小A：你上文刚说不要拾人牙慧，这下又要拾人牙慧，你到底要我干什么？  </p>
</blockquote>
<blockquote>
<p>我：上文讲，学习新方法时，要自己探索，照着官方标准自己理解，而这里，要进入源码的阅读了，我们可以站在巨人们的肩膀上，对源码结构稍微有些了解。后面自己阅读时会更容易些.  </p>
</blockquote>
<blockquote>
<p>小A：我信你了。  </p>
</blockquote>
<p>本文将以Vue数据绑定的核心实现作为例子，所以这一步，需要你在社区找找大V们写好的文章。比如我觉得下面这篇写的不错。  </p>
<p><a href="https://juejin.im/post/5d99be7c6fb9a04e1e7baa34" target="_blank" rel="noopener">Vue3 中的数据侦测
</a>  </p>
<p>第一步先给文章点个👍，支持下原作者。看文章时，忽略掉你已经知道的知识，比如 proxy 的用法，Reflect 的用法。然后试着手敲一遍文章中的代码demo。<br>在这篇文章里你最好自己先实现一遍 Proxy 代理深层对象。<br>以下是我写的demo<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">'array'</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">const</span> array= <span class="built_in">document</span>.querySelector(<span class="string">'#array'</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="javascript">    <span class="keyword">const</span> isObject = <span class="function">(<span class="params">val</span>) =&gt;</span> val !== <span class="literal">null</span> &amp;&amp; <span class="keyword">typeof</span> val === <span class="string">'object'</span></span></span><br><span class="line"><span class="javascript">    <span class="function"><span class="keyword">function</span> <span class="title">proxyMethod</span>(<span class="params">obj</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">      <span class="keyword">let</span> p2 = <span class="keyword">new</span> <span class="built_in">Proxy</span>(obj, &#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">get</span>(target, key, val) &#123;</span></span><br><span class="line"><span class="javascript">          <span class="keyword">const</span> res = <span class="built_in">Reflect</span>.get(target, key, val)</span></span><br><span class="line">          if(isObject(res)) &#123;</span><br><span class="line"><span class="javascript">            <span class="keyword">return</span> proxyMethod(res)</span></span><br><span class="line">          &#125;</span><br><span class="line"><span class="javascript">          <span class="keyword">return</span> res</span></span><br><span class="line">        &#125;,</span><br><span class="line"><span class="javascript">        <span class="keyword">set</span>(target, key, val, receiver) &#123;</span></span><br><span class="line"><span class="javascript">          <span class="keyword">const</span> res = <span class="built_in">Reflect</span>.set(target, key, val)</span></span><br><span class="line">          array.innerHTML = receiver</span><br><span class="line"><span class="javascript">          <span class="built_in">console</span>.log(<span class="string">'set'</span>, receiver)</span></span><br><span class="line"><span class="javascript">          <span class="keyword">return</span> <span class="literal">true</span></span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line"><span class="javascript">      <span class="keyword">return</span> p2</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="javascript">    <span class="keyword">let</span> p = &#123;</span></span><br><span class="line">      arr: [1,2,3],</span><br><span class="line">      c: 2</span><br><span class="line">    &#125;</span><br><span class="line"><span class="javascript">    <span class="keyword">let</span> p2 = proxyMethod(p)</span></span><br><span class="line">    p2.arr.push(8)</span><br><span class="line"><span class="javascript">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span></span><br><span class="line">      p2.arr.push(6)</span><br><span class="line">    &#125;, 1000)</span><br><span class="line">  <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>将社区的文章看的大概，了解源码的核心功能，则可以进行下一步了。  </p>
<h2 id="庖丁解牛"><a href="#庖丁解牛" class="headerlink" title="庖丁解牛"></a>庖丁解牛</h2><p>到目前为止，你知道了源码实现的核心，而其他的就是源码包装核心之后实现功能的代码。举个例子：你现在知道了发动机怎么做，接下来要做的是，装上传动、装上轮胎、装上车架……<br>所以接下来你得对代码的全局有个大概的了解，将代码拆开来，你需要知道轮胎在哪儿？车门在哪儿？  </p>
<p>这个过程，我称之为 “架构拆解”，庖丁解牛，你解架构。那如何解呢。先列举下Vue的文件架构。  </p>
<p>这里推荐一个工具，可以在命令行展示文件的树状结构。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">brew install tree</span><br><span class="line">tree -L 1</span><br><span class="line"></span><br><span class="line">├── compiler-core</span><br><span class="line">├── compiler-dom</span><br><span class="line">├── global.d.ts</span><br><span class="line">├── reactivity</span><br><span class="line">├── runtime-core</span><br><span class="line">├── runtime-dom</span><br><span class="line">├── runtime-test</span><br><span class="line">├── server-renderer</span><br><span class="line">├── shared</span><br><span class="line">├── template-explorer</span><br><span class="line">└── vue</span><br></pre></td></tr></table></figure></p>
<p>接下来逐条对文件夹进行分析。本篇只分析 <code>reactivity</code>文件夹。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── README.md</span><br><span class="line">├── __tests__</span><br><span class="line">├── api-extractor.json</span><br><span class="line">├── index.js</span><br><span class="line">├── package.json</span><br><span class="line">└── src</span><br></pre></td></tr></table></figure></p>
<p>有 README 先看 README。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># @vue/reactivity</span><br><span class="line"></span><br><span class="line">## Usage Note</span><br><span class="line"></span><br><span class="line">This package is inlined into Global &amp; Browser ESM builds of user-facing renderers (e.g. `@vue/runtime-dom`), but also published as a package that can be used standalone. The standalone build should not be used alongside a pre-bundled build of a user-facing renderer, as they will have different internal storage for reactivity connections. A user-facing renderer should re-export all APIs from this package.</span><br><span class="line"></span><br><span class="line">For full exposed APIs, see `src/index.ts`. You can also run `yarn build reactivity --types` from repo root, which will generate an API report at `temp/reactivity.api.md`.</span><br><span class="line"></span><br><span class="line">## Credits</span><br><span class="line"></span><br><span class="line">The implementation of this module is inspired by the following prior art in the JavaScript ecosystem:</span><br><span class="line"></span><br><span class="line">- [Meteor Tracker](https://docs.meteor.com/api/tracker.html)</span><br><span class="line">- [nx-js/reactivity-util](https://github.com/nx-js/reactivity-util)</span><br><span class="line">- [salesforce/observable-membrane](https://github.com/salesforce/observable-membrane)</span><br><span class="line"></span><br><span class="line">## Caveats</span><br><span class="line"></span><br><span class="line">- Built-in objects are not observed except for `Map`, `WeakMap`, `Set` and `WeakSet`.</span><br></pre></td></tr></table></figure></p>
<p>从上段看出来，这个包可以独立使用。至于如何使用，可以看 <code>index.ts</code> 文件，前提是，我们了解它导出的每一对象。  </p>
<p>我们再看看 <code>src</code> 的结构  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── baseHandlers.ts</span><br><span class="line">├── collectionHandlers.ts</span><br><span class="line">├── computed.ts</span><br><span class="line">├── effect.ts</span><br><span class="line">├── index.ts</span><br><span class="line">├── lock.ts</span><br><span class="line">├── operations.ts</span><br><span class="line">├── reactive.ts</span><br><span class="line">└── ref.ts</span><br></pre></td></tr></table></figure>
<p>接下来的工作是标注每一个文件的作用。最好能做备注。从 <code>index.ts</code> 读起，采用 <code>深度优先</code> 的方式。  </p>
<p>接下来我会一行行读，你可以跟随我的脚步……  </p>
<h2 id="秘径追踪"><a href="#秘径追踪" class="headerlink" title="秘径追踪"></a>秘径追踪</h2><blockquote>
<p>index.ts<br><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> &#123; ref, isRef, toRefs, Ref, UnwrapRef &#125; <span class="keyword">from</span> <span class="string">'./ref'</span></span><br></pre></td></tr></table></figure></p>
</blockquote>
<p>先进入 ref 文件看看 ref 方法怎么来的。</p>
<blockquote>
<p>ref.ts<br><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; track, trigger &#125; <span class="keyword">from</span> <span class="string">'./effect'</span></span><br><span class="line"><span class="keyword">import</span> &#123; OperationTypes &#125; <span class="keyword">from</span> <span class="string">'./operations'</span></span><br><span class="line"><span class="keyword">import</span> &#123; isObject &#125; <span class="keyword">from</span> <span class="string">'@vue/shared'</span></span><br><span class="line"><span class="keyword">import</span> &#123; reactive &#125; <span class="keyword">from</span> <span class="string">'./reactive'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> refSymbol = Symbol(__DEV__ ? <span class="string">'refSymbol'</span> : <span class="literal">undefined</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> Ref&lt;T&gt; &#123;</span><br><span class="line">  [refSymbol]: <span class="literal">true</span></span><br><span class="line">  value: UnwrapNestedRefs&lt;T&gt;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> UnwrapNestedRefs&lt;T&gt; = T <span class="keyword">extends</span> Ref&lt;<span class="built_in">any</span>&gt; ? T : UnwrapRef&lt;T&gt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> convert = (val: <span class="built_in">any</span>): <span class="function"><span class="params">any</span> =&gt;</span> (isObject(val) ? reactive(val) : val)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">ref</span>&lt;<span class="title">T</span>&gt;(<span class="params">raw: T</span>): <span class="title">Ref</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">  <span class="comment">// 如果是对象，则用 reactive 方法 包装 raw</span></span><br><span class="line">  raw = convert(raw)</span><br><span class="line">  <span class="comment">// 返回一个 v 对象，在 取value 值时，调用 track 方法，在存 value 值时，调用 trigger方法</span></span><br><span class="line">  <span class="keyword">const</span> v = &#123;</span><br><span class="line">    [refSymbol]: <span class="literal">true</span>,</span><br><span class="line">    <span class="keyword">get</span> value() &#123;</span><br><span class="line">      track(v, OperationTypes.GET, <span class="string">''</span>)</span><br><span class="line">      <span class="keyword">return</span> raw</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="keyword">set</span> value(newVal) &#123;</span><br><span class="line">      raw = convert(newVal)</span><br><span class="line">      trigger(v, OperationTypes.SET, <span class="string">''</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v <span class="keyword">as</span> Ref&lt;T&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
</blockquote>
<p>可以看到，我们遇到了三个未知函数</p>
<ul>
<li>convert 方法里调用了 <code>reactive</code> 方法，对ref 的参数进行了包装。</li>
<li>在 v 对象中， 取value 值时，调用 track 方法，在存 value 值时，调用 trigger方法  </li>
</ul>
<p>继续往下走，看看 reactive 方法的内容，<em>我将我读代码的思路写进了备注里，你可以检索 MARK1 - MARK10 来逐行看思路。</em><br>reactive.ts<br><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; isObject, toTypeString &#125; <span class="keyword">from</span> <span class="string">'@vue/shared'</span></span><br><span class="line"><span class="keyword">import</span> &#123; mutableHandlers, readonlyHandlers &#125; <span class="keyword">from</span> <span class="string">'./baseHandlers'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  mutableCollectionHandlers,</span><br><span class="line">  readonlyCollectionHandlers</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">'./collectionHandlers'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; UnwrapNestedRefs &#125; <span class="keyword">from</span> <span class="string">'./ref'</span></span><br><span class="line"><span class="keyword">import</span> &#123; ReactiveEffect &#125; <span class="keyword">from</span> <span class="string">'./effect'</span></span><br><span class="line"><span class="comment">// WeakMap 主要是用来储存 &#123;target -&gt; key -&gt; dep&#125; 的链接，它更像是 依赖 Dep 的类，它包含了一组 Set，但我们只是简单的储存它们，以减少内存消耗</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> Dep = Set&lt;ReactiveEffect&gt;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> KeyToDepMap = Map&lt;<span class="built_in">string</span> | symbol, Dep&gt;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> targetMap = <span class="keyword">new</span> WeakMap&lt;<span class="built_in">any</span>, KeyToDepMap&gt;()</span><br><span class="line"></span><br><span class="line"><span class="comment">// WeakMaps that store &#123;raw &lt;-&gt; observed&#125; pairs.</span></span><br><span class="line"><span class="keyword">const</span> rawToReactive = <span class="keyword">new</span> WeakMap&lt;<span class="built_in">any</span>, <span class="built_in">any</span>&gt;()</span><br><span class="line"><span class="keyword">const</span> reactiveToRaw = <span class="keyword">new</span> WeakMap&lt;<span class="built_in">any</span>, <span class="built_in">any</span>&gt;()</span><br><span class="line"><span class="keyword">const</span> rawToReadonly = <span class="keyword">new</span> WeakMap&lt;<span class="built_in">any</span>, <span class="built_in">any</span>&gt;()</span><br><span class="line"><span class="keyword">const</span> readonlyToRaw = <span class="keyword">new</span> WeakMap&lt;<span class="built_in">any</span>, <span class="built_in">any</span>&gt;()</span><br><span class="line"></span><br><span class="line"><span class="comment">// WeakSets for values that are marked readonly or non-reactive during</span></span><br><span class="line"><span class="comment">// observable creation.</span></span><br><span class="line"><span class="keyword">const</span> readonlyValues = <span class="keyword">new</span> WeakSet&lt;<span class="built_in">any</span>&gt;()</span><br><span class="line"><span class="keyword">const</span> nonReactiveValues = <span class="keyword">new</span> WeakSet&lt;<span class="built_in">any</span>&gt;()</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> collectionTypes = <span class="keyword">new</span> Set&lt;<span class="built_in">Function</span>&gt;([Set, Map, WeakMap, WeakSet])</span><br><span class="line"><span class="keyword">const</span> observableValueRE = <span class="regexp">/^\[object (?:Object|Array|Map|Set|WeakMap|WeakSet)\]$/</span></span><br><span class="line"><span class="comment">// MARK9: -&gt;进去看</span></span><br><span class="line"><span class="keyword">const</span> canObserve = (value: <span class="built_in">any</span>): <span class="function"><span class="params">boolean</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="comment">// 不是vue 对象</span></span><br><span class="line">    !value._isVue &amp;&amp;</span><br><span class="line">    <span class="comment">// 不是 vNode</span></span><br><span class="line">    !value._isVNode &amp;&amp;</span><br><span class="line">    <span class="comment">// 白名单： Object|Array|Map|Set|WeakMap|WeakSet</span></span><br><span class="line">    observableValueRE.test(toTypeString(value)) &amp;&amp;</span><br><span class="line">    <span class="comment">// 没有代理过的</span></span><br><span class="line">    !nonReactiveValues.has(value)</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">reactive</span>&lt;<span class="title">T</span> <span class="title">extends</span> <span class="title">object</span>&gt;(<span class="params">target: T</span>): <span class="title">UnwrapNestedRefs</span>&lt;<span class="title">T</span>&gt;</span></span><br><span class="line"><span class="function"><span class="title">export</span> <span class="function"><span class="keyword">function</span> <span class="title">reactive</span>(<span class="params">target: object</span>) </span>&#123;</span></span><br><span class="line"><span class="function">  // <span class="title">MARK1</span>: 如果<span class="title">target</span> 只读，则返回它</span></span><br><span class="line"><span class="function">  <span class="title">if</span> (<span class="params">readonlyToRaw.has(target)</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> target</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// MARK2: 如果target被用户设置为只读，则让它只读，并返回</span></span><br><span class="line">  <span class="keyword">if</span> (readonlyValues.has(target)) &#123;</span><br><span class="line">    <span class="keyword">return</span> readonly(target)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// MARK3: 貌似到重点了</span></span><br><span class="line">  <span class="keyword">return</span> createReactiveObject(</span><br><span class="line">    target,</span><br><span class="line">    <span class="comment">// MARK3: 底下这一堆是 weakMap，先不管它们</span></span><br><span class="line">    rawToReactive,</span><br><span class="line">    reactiveToRaw,</span><br><span class="line">    mutableHandlers,</span><br><span class="line">    mutableCollectionHandlers</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">readonly</span>&lt;<span class="title">T</span> <span class="title">extends</span> <span class="title">object</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  target: T</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Readonly</span>&lt;<span class="title">UnwrapNestedRefs</span>&lt;<span class="title">T</span>&gt;&gt;</span></span><br><span class="line"><span class="function"><span class="title">export</span> <span class="function"><span class="keyword">function</span> <span class="title">readonly</span>(<span class="params">target: object</span>) </span>&#123;</span></span><br><span class="line"><span class="function">  // <span class="title">value</span> <span class="title">is</span> <span class="title">a</span> <span class="title">mutable</span> <span class="title">observable</span>, <span class="title">retrieve</span> <span class="title">its</span> <span class="title">original</span> <span class="title">and</span> <span class="title">return</span></span></span><br><span class="line"><span class="function">  // <span class="title">a</span> <span class="title">readonly</span> <span class="title">version</span>.</span></span><br><span class="line"><span class="function">  <span class="title">if</span> (<span class="params">reactiveToRaw.has(target)</span>) </span>&#123;</span><br><span class="line">    target = reactiveToRaw.get(target)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> createReactiveObject(</span><br><span class="line">    target,</span><br><span class="line">    rawToReadonly,</span><br><span class="line">    readonlyToRaw,</span><br><span class="line">    readonlyHandlers,</span><br><span class="line">    readonlyCollectionHandlers</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createReactiveObject</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  target: <span class="built_in">any</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  toProxy: WeakMap&lt;<span class="built_in">any</span>, <span class="built_in">any</span>&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">  toRaw: WeakMap&lt;<span class="built_in">any</span>, <span class="built_in">any</span>&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">  baseHandlers: ProxyHandler&lt;<span class="built_in">any</span>&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">  collectionHandlers: ProxyHandler&lt;<span class="built_in">any</span>&gt;</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// MARK4: 很明显，这里只 typeof判断，Array Date之类的也能通过</span></span><br><span class="line">  <span class="keyword">if</span> (!isObject(target)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">      <span class="built_in">console</span>.warn(<span class="string">`value cannot be made reactive: <span class="subst">$&#123;<span class="built_in">String</span>(target)&#125;</span>`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> target</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// MARK5: 已经代理过的对象，不需要在代理</span></span><br><span class="line">  <span class="keyword">let</span> observed = toProxy.get(target)</span><br><span class="line">  <span class="comment">// MARK6: 这里用 void 0代替了undfined，防止 undfined 被重写。get 到新姿势了。</span></span><br><span class="line">  <span class="keyword">if</span> (observed !== <span class="built_in">void</span> <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> observed</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// MARK7: 目标本身就是一个 proxy 对象</span></span><br><span class="line">  <span class="keyword">if</span> (toRaw.has(target)) &#123;</span><br><span class="line">    <span class="keyword">return</span> target</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// MARK8: 只有加入白名单的对象才能被代理</span></span><br><span class="line">  <span class="keyword">if</span> (!canObserve(target)) &#123;</span><br><span class="line">    <span class="keyword">return</span> target</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// MARK10: collectionTypes 可以看到是一个Set结构，放了几个构造函数：[Set, Map, WeakMap, WeakSet]，这个三目表达式就是区分了以上四种对象和其他对象的 handlers，我们先从 baseHandlers 看起</span></span><br><span class="line">  <span class="keyword">const</span> handlers = collectionTypes.has(target.<span class="keyword">constructor</span>)</span><br><span class="line">    ? collectionHandlers</span><br><span class="line">    : baseHandlers</span><br><span class="line">  observed = new Proxy(<span class="params">target, handlers</span>)</span><br><span class="line">  // 以下则是存储下已经代理过的对象，以作优化。</span><br><span class="line">  toProxy.set(<span class="params">target, observed</span>)</span><br><span class="line">  toRaw.set(<span class="params">observed, target</span>)</span><br><span class="line">  if (<span class="params">!targetMap.has(target)</span>) &#123;</span><br><span class="line">    targetMap.set(target, <span class="keyword">new</span> Map())</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 返回代理后的对象</span></span><br><span class="line">  <span class="keyword">return</span> observed</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">isReactive</span>(<span class="params">value: <span class="built_in">any</span></span>): <span class="title">boolean</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> reactiveToRaw.has(value) || readonlyToRaw.has(value)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">isReadonly</span>(<span class="params">value: <span class="built_in">any</span></span>): <span class="title">boolean</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> readonlyToRaw.has(value)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">toRaw</span>&lt;<span class="title">T</span>&gt;(<span class="params">observed: T</span>): <span class="title">T</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> reactiveToRaw.get(observed) || readonlyToRaw.get(observed) || observed</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">markReadonly</span>&lt;<span class="title">T</span>&gt;(<span class="params">value: T</span>): <span class="title">T</span> </span>&#123;</span><br><span class="line">  readonlyValues.add(value)</span><br><span class="line">  <span class="keyword">return</span> value</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">markNonReactive</span>&lt;<span class="title">T</span>&gt;(<span class="params">value: T</span>): <span class="title">T</span> </span>&#123;</span><br><span class="line">  nonReactiveValues.add(value)</span><br><span class="line">  <span class="keyword">return</span> value</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>reactive.ts 终于完了，接下来我们从 上文的 MARK10 进入 到 <code>handler.ts</code> 中，老规矩，这里的代码思路从 MARK11 开始。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; reactive, readonly, toRaw &#125; <span class="keyword">from</span> <span class="string">'./reactive'</span></span><br><span class="line"><span class="keyword">import</span> &#123; OperationTypes &#125; <span class="keyword">from</span> <span class="string">'./operations'</span></span><br><span class="line"><span class="keyword">import</span> &#123; track, trigger &#125; <span class="keyword">from</span> <span class="string">'./effect'</span></span><br><span class="line"><span class="keyword">import</span> &#123; LOCKED &#125; <span class="keyword">from</span> <span class="string">'./lock'</span></span><br><span class="line"><span class="keyword">import</span> &#123; isObject, hasOwn &#125; <span class="keyword">from</span> <span class="string">'@vue/shared'</span></span><br><span class="line"><span class="keyword">import</span> &#123; isRef &#125; <span class="keyword">from</span> <span class="string">'./ref'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> builtInSymbols = <span class="keyword">new</span> <span class="built_in">Set</span>(</span><br><span class="line">  <span class="built_in">Object</span>.getOwnPropertyNames(<span class="built_in">Symbol</span>)</span><br><span class="line">    .map(<span class="function"><span class="params">key</span> =&gt;</span> (<span class="built_in">Symbol</span> <span class="keyword">as</span> any)[key])</span><br><span class="line">    .filter(<span class="function"><span class="params">value</span> =&gt;</span> <span class="keyword">typeof</span> value === <span class="string">'symbol'</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createGetter</span>(<span class="params">isReadonly: boolean</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">get</span>(<span class="params">target: any, key: string | symbol, receiver: any</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> res = <span class="built_in">Reflect</span>.get(target, key, receiver)</span><br><span class="line">    <span class="comment">//MARK13: 防止key为Symbol的内置对象，比如 Symbol.iterator</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> key === <span class="string">'symbol'</span> &amp;&amp; builtInSymbols.has(key)) &#123;</span><br><span class="line">      <span class="keyword">return</span> res</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//MARK14: 从上文知道，被ref 包装过，则返回</span></span><br><span class="line">    <span class="keyword">if</span> (isRef(res)) &#123;</span><br><span class="line">      <span class="keyword">return</span> res.value</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 这里貌似是依赖收集的，暂且不深入</span></span><br><span class="line">    track(target, OperationTypes.GET, key)</span><br><span class="line">    <span class="comment">// MARK15 对深层对象再次包装</span></span><br><span class="line">    <span class="comment">// res 是深层对象，如果它不是只读对象，则调用 reactive 继续代理，上文自己实现过，这里很好理解</span></span><br><span class="line">    <span class="keyword">return</span> isObject(res)</span><br><span class="line">      ? isReadonly</span><br><span class="line">        ? <span class="comment">// need to lazy access readonly and reactive here to avoid</span></span><br><span class="line">          <span class="comment">// circular dependency</span></span><br><span class="line">          readonly(res)</span><br><span class="line">        : reactive(res)</span><br><span class="line">      : res</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">set</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  target: any,</span></span></span><br><span class="line"><span class="function"><span class="params">  key: string | symbol,</span></span></span><br><span class="line"><span class="function"><span class="params">  value: any,</span></span></span><br><span class="line"><span class="function"><span class="params">  receiver: any</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">boolean</span> </span>&#123;</span><br><span class="line">  <span class="comment">// MARK16 优化：之前有存过，直接拿就行了</span></span><br><span class="line">  value = toRaw(value)</span><br><span class="line">  <span class="comment">// MARK17 key 是否为 taget 的属性，</span></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * export const hasOwn = (</span></span><br><span class="line"><span class="comment">        val: object,</span></span><br><span class="line"><span class="comment">        key: string | symbol</span></span><br><span class="line"><span class="comment">      ): key is keyof typeof val =&gt; hasOwnProperty.call(val, key)</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">      这个方法是解决 数组push时，会调用两次 set 的情况，比如 arr.push(1)</span></span><br><span class="line"><span class="comment">      第一次set，在数组尾部添加1</span></span><br><span class="line"><span class="comment">      第二次set，给数组添加length属性</span></span><br><span class="line"><span class="comment">      hasOwnProperty 方法用来判断目标对象是否含有指定属性。数组本身就有length的属性，所以这里是 true</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">const</span> hadKey = hasOwn(target, key)</span><br><span class="line">  <span class="keyword">const</span> oldValue = target[key]</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * MARK18 如果 value 不是响应式数据，则需要将其赋值给 oldValue</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">if</span> (isRef(oldValue) &amp;&amp; !isRef(value)) &#123;</span><br><span class="line">    <span class="comment">//MARK19 这将触发 oldValue 的 set value 方法，如果 isObject(value) ，则会经过 reactive 再包装一次，将其变成响应式数据</span></span><br><span class="line">    oldValue.value = value</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> result = <span class="built_in">Reflect</span>.set(target, key, value, receiver)</span><br><span class="line">  <span class="comment">// MARK20 target 如果只读 或者 存在于 reactiveToRaw 则不进入条件，reactiveToRaw 储存着代理后的对象</span></span><br><span class="line">  <span class="keyword">if</span> (target === toRaw(receiver)) &#123;</span><br><span class="line">    <span class="comment">/* istanbul ignore else */</span></span><br><span class="line">    <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">      <span class="keyword">const</span> extraInfo = &#123; oldValue, <span class="attr">newValue</span>: value &#125;</span><br><span class="line">      <span class="keyword">if</span> (!hadKey) &#123;</span><br><span class="line">        trigger(target, OperationTypes.ADD, key, extraInfo)</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (value !== oldValue) &#123;</span><br><span class="line">        trigger(target, OperationTypes.SET, key, extraInfo)</span><br><span class="line">      &#125;</span><br><span class="line">    <span class="comment">// MARK21 只看生产环境</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">//MARK22 属性新增，触发 ADD 枚举</span></span><br><span class="line">      <span class="keyword">if</span> (!hadKey) &#123;</span><br><span class="line">        trigger(target, OperationTypes.ADD, key)</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (value !== oldValue) &#123;</span><br><span class="line">        <span class="comment">//MARK23 属性修改，触发 SET 枚举</span></span><br><span class="line">        trigger(target, OperationTypes.SET, key)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="comment">/** MARK24 对应 MARK17</span></span><br><span class="line"><span class="comment">     * else &#123;&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">deleteProperty</span>(<span class="params">target: any, key: string | symbol</span>): <span class="title">boolean</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> hadKey = hasOwn(target, key)</span><br><span class="line">  <span class="keyword">const</span> oldValue = target[key]</span><br><span class="line">  <span class="keyword">const</span> result = <span class="built_in">Reflect</span>.deleteProperty(target, key)</span><br><span class="line">  <span class="keyword">if</span> (hadKey) &#123;</span><br><span class="line">    <span class="comment">/* istanbul ignore else */</span></span><br><span class="line">    <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">      trigger(target, OperationTypes.DELETE, key, &#123; oldValue &#125;)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      trigger(target, OperationTypes.DELETE, key)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">has</span>(<span class="params">target: any, key: string | symbol</span>): <span class="title">boolean</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> result = <span class="built_in">Reflect</span>.has(target, key)</span><br><span class="line">  track(target, OperationTypes.HAS, key)</span><br><span class="line">  <span class="keyword">return</span> result</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function ownKeys(target: any): (string | number | symbol)[] &#123;</span><br><span class="line">  track(target, OperationTypes.ITERATE)</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Reflect</span>.ownKeys(target)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> mutableHandlers: ProxyHandler&lt;any&gt; = &#123;</span><br><span class="line">  <span class="keyword">get</span>: createGetter(false),</span><br><span class="line">  <span class="keyword">set</span>,</span><br><span class="line">  deleteProperty,</span><br><span class="line">  has,</span><br><span class="line">  ownKeys</span><br><span class="line">&#125;</span><br><span class="line">// MARK11 入口函数</span><br><span class="line">export const readonlyHandlers: ProxyHandler&lt;any&gt; = &#123;</span><br><span class="line">  <span class="comment">// MARK12: 创建 getter</span></span><br><span class="line">  <span class="keyword">get</span>: createGetter(true),</span><br><span class="line">// MARK12: 创建 setter</span><br><span class="line">  <span class="keyword">set</span>(target: any, key: string | symbol, value: any, receiver: any): boolean &#123;</span><br><span class="line">    <span class="keyword">if</span> (LOCKED) &#123;</span><br><span class="line">      <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">        <span class="built_in">console</span>.warn(</span><br><span class="line">          <span class="string">`Set operation on key "<span class="subst">$&#123;<span class="built_in">String</span>(key)&#125;</span>" failed: target is readonly.`</span>,</span><br><span class="line">          target</span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">set</span>(target, key, value, receiver)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  deleteProperty(target: any, key: string | symbol): boolean &#123;</span><br><span class="line">    <span class="keyword">if</span> (LOCKED) &#123;</span><br><span class="line">      <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">        <span class="built_in">console</span>.warn(</span><br><span class="line">          <span class="string">`Delete operation on key "<span class="subst">$&#123;<span class="built_in">String</span>(</span></span></span><br><span class="line"><span class="string"><span class="subst">            key</span></span></span><br><span class="line"><span class="string"><span class="subst">          )&#125;</span>" failed: target is readonly.`</span>,</span><br><span class="line">          target</span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> deleteProperty(target, key)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  has,</span><br><span class="line">  ownKeys</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="未完待续"><a href="#未完待续" class="headerlink" title="未完待续"></a>未完待续</h2><p>到此为止，你对代码整体有了模糊的理解，但还有些棱角不清晰，比如：</p>
<ul>
<li>MARK4 那一连串 <code>WeakMap</code> 是干啥的？</li>
<li>MARK10 下面为什么 set 了多次？<br>……<br>在后面的文章中，我会逐条分析。读懂源码是个漫长的过程，未完待续……</li>
</ul>

        </section>
    </article>
    
        
  </div>
  <aside>
    
    <div class="toc-container">
        <h1>目录</h1>
        <div class="content">
            <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#先唠会儿嗑"><span class="toc-number">1.</span> <span class="toc-text">先唠会儿嗑</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#现实总不如意"><span class="toc-number">2.</span> <span class="toc-text">现实总不如意</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#磨刀不误砍柴工"><span class="toc-number">3.</span> <span class="toc-text">磨刀不误砍柴工</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#预知此事先躬行"><span class="toc-number">4.</span> <span class="toc-text">预知此事先躬行</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#要拾人牙慧"><span class="toc-number">5.</span> <span class="toc-text">要拾人牙慧</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#庖丁解牛"><span class="toc-number">6.</span> <span class="toc-text">庖丁解牛</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#秘径追踪"><span class="toc-number">7.</span> <span class="toc-text">秘径追踪</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#未完待续"><span class="toc-number">8.</span> <span class="toc-text">未完待续</span></a></li></ol>
        </div>
    </div>
    
  </aside>
</main>



  <footer>
  <div class="copyright">
    <div>
      &copy; 2021 | Powered by <a href="https://hexo.io" target="_blank">Hexo</a>&nbsp
    </div>
    <div>
      Theme by <a href="https://github.com/lewis-geek/hexo-theme-Aath" target="_blank">Aath</a>
    </div>
  </div>
</footer>


<script src="https://cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
<script src="/lib/in-view.min.js"></script>
<script src="/lib/lodash.min.js"></script>
<script>
  var isDown = true
  var oldY = 0
  inView.offset(50)

  document.body.addEventListener('touchstart', function(){});
  
  window.addEventListener('scroll', _.throttle(e => {
    var currentY = window.scrollY
    if((oldY - currentY) < 0) {
      isDown = true
    } else {
      isDown = false
    }
    oldY = currentY
  }, 250))

  $("article img").each(function() {
      var strA = "<a data-fancybox='gallery' href='" + this.src + "'></a>";
      $(this).wrapAll(strA);
  });

  $('.toc-link').each(function() {
      var href = $(this).attr("href");
      
      inView(href).on('exit', () => {
        if (isDown) {
          handleActive(href)
        }
      })

      inView(href).on('enter', () => {
        if (!isDown) {
          handleActive(href)
        }
      })

      this.onclick = function(e) {
        var pos = $(href).offset().top - 10;
        $("html,body").animate({scrollTop: pos}, 300);
        setTimeout(() => {
          handleActive(href)
        }, 350)
        return false
      }
  })

  function handleActive(href) {
    document.querySelectorAll('.toc-link').forEach(elm => {
      elm.classList.remove('active')
    })
    document.querySelector(".toc [href='"+ href +"']").classList.add('active')
  }
</script>
<script src="/lib/jquery.fancybox.min.js"></script>


</body>
</html>
