<!DOCTYPE html>
<html lang=>
  <head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <meta name="description" content>
  <meta name="keywords" content>
  
    <link rel="icon" href>
  
    
  <title>记两次AST的应用 | qqqdu&#39;s blog</title>
  <link rel="stylesheet" href="/style.css">
  <link rel="stylesheet" href="/lib/jquery.fancybox.min.css">
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
</head>

<body>
  <header>
  <div class="header-container">
    <a class='logo' href="/">
      <span>qqqdu's blog</span>
    </a>
    <ul class="right-header">
      
        <li class="nav-item">
          
            <a href="/" class="item-link">首页</a>
          
        </li>
      
        <li class="nav-item">
          
            <a href="/about" class="item-link">关于</a>
          
        </li>
      
        <li class="nav-item">
          
            <a href="/archives" class="item-link">归档</a>
          
        </li>
      
        <li class="nav-item">
          
            <a href="/tags" class="item-link">标签</a>
          
        </li>
      
    </ul>
  </div>
</header>

  <main id='post'>
  <div class="content">
    <article>
        <section class="content markdown-body">
          <h1>记两次AST的应用</h1>
          <div class='post-meta'>
            <i class="fa fa-calendar" aria-hidden="true"></i> <time>2019/09/01</time>
            
            
          </div>
          <p>终于将 AST 用在需求里辣！</p>
<h2 id="AST-和-我"><a href="#AST-和-我" class="headerlink" title="AST 和 我"></a>AST 和 我</h2><p>之前有在 TOH 前端小组里分享过 AST 的相关概念，以及 <code>recast</code> 库来操作 AST 树，<br>你可以在这看这篇文章</p>
<p><a href="http://qqqdu.com/2019/03/18/javascript-parse/" target="_blank" rel="noopener">抽象语法树(AST)</a></p>
<p>当时分享完觉得很空旷，虽然了解了其部分基础概念，也做了一个小 demo，但还是太过于表面，没有实际应用，纸上得来终觉浅。恰好这周有两次机会用上了 AST。<br>我的体验是：</p>
<p>真 TMD 爽！</p>
<h2 id="枚举库-和-JSDOC-的碰撞"><a href="#枚举库-和-JSDOC-的碰撞" class="headerlink" title="枚举库 和 JSDOC 的碰撞"></a>枚举库 和 JSDOC 的碰撞</h2><p>当 xusy 整理完 项目的枚举，并将它封装为一个库后，MR 发了过来。</p>
<p>之前项目里零零散散的枚举统一由私有库来维护，再也不用每个项目都维护一份了。</p>
<p>但文档似乎有点多，好几十个 js 脚本。于是我</p>
<p>commit：应该再出一份文档，告知开发者这些枚举都是干啥的，这样不需要开发者找代码，而直接调用它。</p>
<p>xusy 说，可以，然后调研了下 JSDOC 库，发现代码格式不符合 JSDOC 的要求。比如：<br>备注要像前者，而不是后者：<br><code>/** 这是JSDOC可识别的备注 */</code><br><code>/* 这是JSDOC不可识别的备注 */</code></p>
<p>比如：<br>导出的类型要像前者，而不是后者：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> applyTypeObj = &#123;</span><br><span class="line">	<span class="comment">/** 普通投递 */</span></span><br><span class="line">	NORMAL_APPLY: <span class="number">0</span>,</span><br><span class="line">	<span class="comment">/** 一键投递 */</span></span><br><span class="line">	ONE_CLICK_APPLY: <span class="number">1</span>,</span><br><span class="line">	<span class="comment">/** 邀请投递 */</span></span><br><span class="line">	INVITE_APPLY: <span class="number">2</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> applyTypeEnum = <span class="built_in">Object</span>.freeze(applyTypeObj)</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 普通投递</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> NORMAL_APPLY = <span class="number">0</span></span><br><span class="line"><span class="comment">// 一键投递</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> ONE_CLICK_APPLY = <span class="number">1</span></span><br><span class="line"><span class="comment">// 邀请投递</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> INVITE_APPLY = <span class="number">2</span></span><br></pre></td></tr></table></figure>
<p>有 21 个文件、以及文件里的大量枚举 需要这样处理，你可以算算需要多少人工成本，并且处理的过程是枯燥，乏味，容易出错的。</p>
<h3 id="你为什么不问问神奇的-AST-呢"><a href="#你为什么不问问神奇的-AST-呢" class="headerlink" title="你为什么不问问神奇的 AST 呢"></a>你为什么不问问神奇的 AST 呢</h3><p>有了上次分享的经验，这次应该很容易写出这样的转换代码。<br>先构思下基本的流程</p>
<p>递归读取项目文件 -&gt; 读文件 -&gt; AST 操作 -&gt; 写文件</p>
<p>这个流程核心就是 AST 操作。依然用我们可爱的 <code>recast</code> 库。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">recastFileName</span>(<span class="params">path, fileName</span>) </span>&#123;</span><br><span class="line">	fs.readFile(path, <span class="function"><span class="keyword">function</span>(<span class="params">err, data</span>) </span>&#123;</span><br><span class="line">		<span class="comment">// 读取文件失败/错误</span></span><br><span class="line">		<span class="keyword">if</span> (err) &#123;</span><br><span class="line">			<span class="keyword">throw</span> err</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">const</span> code = data.toString()</span><br><span class="line">		<span class="built_in">console</span>.log(code)</span><br><span class="line">		<span class="keyword">const</span> ast = recast.parse(code)</span><br><span class="line">		<span class="keyword">let</span> i = <span class="number">0</span></span><br><span class="line">		<span class="comment">// 要做的事情很简单，把所有 var 定义的 并且值是 Literal 整合起来</span></span><br><span class="line">		<span class="keyword">const</span> maps = &#123;&#125;</span><br><span class="line">		<span class="comment">// 各个字段的备注存在这</span></span><br><span class="line">		<span class="keyword">const</span> markMap = &#123;&#125;</span><br><span class="line">		<span class="keyword">let</span> markDown = <span class="string">''</span></span><br><span class="line">		recast.visit(ast, &#123;</span><br><span class="line">			visitExportNamedDeclaration: <span class="function"><span class="keyword">function</span>(<span class="params">path</span>) </span>&#123;</span><br><span class="line">				<span class="keyword">const</span> init = path.node.declaration.declarations[<span class="number">0</span>].init</span><br><span class="line">				<span class="keyword">const</span> key = path.node.declaration.declarations[<span class="number">0</span>].id.name</span><br><span class="line">				<span class="keyword">let</span> value = init.value</span><br><span class="line">				<span class="keyword">const</span> type = init.type</span><br><span class="line">				<span class="keyword">if</span> (type === <span class="string">'UnaryExpression'</span>) &#123;</span><br><span class="line">					value = <span class="built_in">eval</span>(<span class="string">`<span class="subst">$&#123;init.operator&#125;</span><span class="subst">$&#123;init.argument.value&#125;</span>`</span>)</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">if</span> (type === <span class="string">'Literal'</span> || type === <span class="string">'UnaryExpression'</span>) &#123;</span><br><span class="line">					maps[key] = value</span><br><span class="line"></span><br><span class="line">					path.node.comments &amp;&amp;</span><br><span class="line">						path.node.comments.map(<span class="function"><span class="params">item</span> =&gt;</span> &#123;</span><br><span class="line">							markDown = <span class="string">`/**</span></span><br><span class="line"><span class="string">* Enum for <span class="subst">$&#123;fileName&#125;</span></span></span><br><span class="line"><span class="string">* <span class="subst">$&#123;item.value&#125;</span></span></span><br><span class="line"><span class="string">* @enum &#123;number&#125;</span></span><br><span class="line"><span class="string">*/\n`</span></span><br><span class="line">						&#125;)</span><br><span class="line">					<span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">			&#125;,</span><br><span class="line">			visitVariableDeclaration: <span class="function"><span class="keyword">function</span>(<span class="params">path</span>) </span>&#123;</span><br><span class="line">				<span class="keyword">if</span> (</span><br><span class="line">					!path.value.declarations ||</span><br><span class="line">					!path.value.declarations[<span class="number">0</span>] ||</span><br><span class="line">					!path.value.declarations[<span class="number">0</span>].init.elements</span><br><span class="line">				) &#123;</span><br><span class="line">					<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">				&#125;</span><br><span class="line">				<span class="built_in">console</span>.log(<span class="string">'定义'</span>)</span><br><span class="line">				<span class="built_in">console</span>.log(path.value.declarations[<span class="number">0</span>].init.elements)</span><br><span class="line">				path.value.declarations[<span class="number">0</span>].init.elements.map(<span class="function"><span class="params">element</span> =&gt;</span> &#123;</span><br><span class="line">					<span class="keyword">const</span> key = element.properties[<span class="number">0</span>].value.name</span><br><span class="line">					<span class="keyword">const</span> value = element.properties[<span class="number">1</span>].value.value</span><br><span class="line">					element.properties[<span class="number">0</span>].value = memberExpression(id(<span class="string">`<span class="subst">$&#123;fileName&#125;</span>Obj`</span>), id(key))</span><br><span class="line">					markMap[key] = value</span><br><span class="line">				&#125;)</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;)</span><br><span class="line">		<span class="keyword">if</span> (!<span class="built_in">Object</span>.keys(maps).length) &#123;</span><br><span class="line">			<span class="built_in">console</span>.log(<span class="string">'无需转换'</span>)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">let</span> mapString = <span class="string">'&#123;\n'</span></span><br><span class="line">		<span class="built_in">Object</span>.keys(maps).map(<span class="function">(<span class="params">key, index</span>) =&gt;</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (markMap[key]) mapString += <span class="string">`  /** <span class="subst">$&#123;markMap[key]&#125;</span> */\n`</span></span><br><span class="line">			<span class="keyword">if</span> (index === <span class="built_in">Object</span>.keys(maps).length - <span class="number">1</span>) &#123;</span><br><span class="line">				mapString += <span class="string">`  "<span class="subst">$&#123;key&#125;</span>": <span class="subst">$&#123;maps[key]&#125;</span>\n`</span></span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				mapString += <span class="string">`  "<span class="subst">$&#123;key&#125;</span>": <span class="subst">$&#123;maps[key]&#125;</span>,\n`</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;)</span><br><span class="line">		mapString += <span class="string">'&#125;'</span></span><br><span class="line">		<span class="keyword">const</span> res = <span class="string">`const <span class="subst">$&#123;fileName&#125;</span>Obj = <span class="subst">$&#123;mapString&#125;</span>\nexport const <span class="subst">$&#123;fileName&#125;</span>Enum = Object.freeze(<span class="subst">$&#123;fileName&#125;</span>Obj)\n`</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">const</span> output = res + recast.print(ast).code</span><br><span class="line">		<span class="keyword">const</span> finel = recast.print(recast.parse(output)).code</span><br><span class="line">		<span class="built_in">console</span>.log(finel)</span><br><span class="line">		<span class="built_in">console</span>.log(output)</span><br><span class="line">		fs.writeFile(path, <span class="string">`<span class="subst">$&#123;markDown&#125;</span>\n<span class="subst">$&#123;finel&#125;</span>`</span>, &#123;&#125;, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">			<span class="built_in">console</span>.log(<span class="string">`wirte <span class="subst">$&#123;fileName&#125;</span> OK!`</span>)</span><br><span class="line">		&#125;)</span><br><span class="line">	&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代码看起来很懵逼，这里只讲讲核心代码。  </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> map = [](&#123;</span><br><span class="line">	<span class="comment">// 很容易看出来，这个方法是用来捕捉 export 语句的</span></span><br><span class="line">	visitExportNamedDeclaration: <span class="function"><span class="keyword">function</span>(<span class="params">path</span>) </span>&#123;</span><br><span class="line">		<span class="keyword">const</span> init = path.node.declaration.declarations[<span class="number">0</span>].init</span><br><span class="line">		<span class="keyword">const</span> key = path.node.declaration.declarations[<span class="number">0</span>].id.name</span><br><span class="line">		<span class="keyword">let</span> value = init.value</span><br><span class="line">		<span class="keyword">const</span> type = init.type</span><br><span class="line">		<span class="comment">/* 将</span></span><br><span class="line"><span class="comment">      export const NORMAL_APPLY = 0</span></span><br><span class="line"><span class="comment">      有用的信息拿出来，存进对象里</span></span><br><span class="line"><span class="comment">      maps: &#123; NORMAL_APPLY: 0 &#125;</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">		<span class="keyword">if</span> (type === <span class="string">'Literal'</span> || type === <span class="string">'UnaryExpression'</span>) &#123;</span><br><span class="line">			maps[key] = value</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>当我们枚举都存到 map 对象里的时候，就可以拼接 map 对象，然后 塞进 代码文件里了。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> mapString = <span class="string">'&#123;\n'</span></span><br><span class="line"><span class="built_in">Object</span>.keys(maps).map(<span class="function">(<span class="params">key, index</span>) =&gt;</span> &#123;</span><br><span class="line">	<span class="keyword">if</span> (markMap[key]) mapString += <span class="string">`  /** <span class="subst">$&#123;markMap[key]&#125;</span> */\n`</span></span><br><span class="line">	<span class="keyword">if</span> (index === <span class="built_in">Object</span>.keys(maps).length - <span class="number">1</span>) &#123;</span><br><span class="line">		mapString += <span class="string">`  "<span class="subst">$&#123;key&#125;</span>": <span class="subst">$&#123;maps[key]&#125;</span>\n`</span></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		mapString += <span class="string">`  "<span class="subst">$&#123;key&#125;</span>": <span class="subst">$&#123;maps[key]&#125;</span>,\n`</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;)</span><br><span class="line">mapString += <span class="string">'&#125;'</span></span><br><span class="line">writeFile(mapString)</span><br></pre></td></tr></table></figure>
<p>当然，还有很多地方需要注意，比如文件头统一的备注，枚举的单独备注。这里就不赘述了。你可以翻到最上面细读。</p>
<p>这个需求做的还算顺利。</p>
<h2 id="又一个需求"><a href="#又一个需求" class="headerlink" title="又一个需求"></a>又一个需求</h2><h3 id="小程序路由参数修改"><a href="#小程序路由参数修改" class="headerlink" title="小程序路由参数修改"></a>小程序路由参数修改</h3><p>当我花了半天做完 枚举库 的转化后，内心有点小激动，恰好当前版本有一个需求和上面的需求很像。  </p>
<p>小程序项目，路由跳转是这样的：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wx.navigateTo(&#123;</span><br><span class="line">    url: <span class="string">`/pages/resumeOptimize?jobId=<span class="subst">$&#123;<span class="keyword">this</span>.jobId&#125;</span>&amp;resume_enhance_source=apply_work_success&amp;workid=<span class="subst">$&#123;<span class="keyword">this</span>.jobId&#125;</span>&amp;service_type=resume_optimization`</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p>长、丑陋、后期加参数容易出错。  </p>
<p>所以需要写成这样。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">wx.navigateTo(&#123;</span><br><span class="line">  url: <span class="string">`/pages/resumeOptimize?<span class="subst">$&#123;qs.stringify(&#123;</span></span></span><br><span class="line"><span class="string"><span class="subst">    jobId: <span class="keyword">this</span>.jobId,</span></span></span><br><span class="line"><span class="string"><span class="subst">    resume_enhance_source: <span class="string">'apply_work_success'</span>,</span></span></span><br><span class="line"><span class="string"><span class="subst">    workid: <span class="keyword">this</span>.jobId,</span></span></span><br><span class="line"><span class="string"><span class="subst">    service_type: <span class="string">'resume_optimization'</span></span></span></span><br><span class="line"><span class="string"><span class="subst">  &#125;</span>)&#125;`</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p>优雅，缩进漂亮，容易维护。  </p>
<h3 id="再问问神奇的-AST-？"><a href="#再问问神奇的-AST-？" class="headerlink" title="再问问神奇的 AST ？"></a>再问问神奇的 AST ？</h3><p>这次的显然比上次难。首先代码文件不是 js，而是 <code>.wpy</code>。  </p>
<p>因为小程序用了 wepy 框架，类 vue 结构。<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>首先要从这个结构里单独将 <code>script</code> 抽出来。当然是用强大的正则了。<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">function getScript(code) &#123;</span><br><span class="line">  let jsReg = /<span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">[\s|\S]*?<span class="xml"><span class="tag">&lt;<span class="name">\</span>/<span class="attr">script</span>&gt;</span></span><span class="regexp">/ig;</span></span></span><br><span class="line"><span class="javascript">  <span class="keyword">const</span> scriptColletion = code.match(jsReg)[<span class="number">0</span>].replace(<span class="regexp">/&lt;script&gt;/</span>, <span class="string">''</span>).replace(<span class="regexp">/&lt;\/script&gt;/</span>, <span class="string">''</span>);</span></span><br><span class="line"><span class="javascript">  <span class="keyword">return</span> scriptColletion</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>很容易拿到了 <code>script</code> 的内容。<br>假设我们将 ast 操作完成了，要将代码文件存回去，同样的。<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">// 再把script设置回去</span><br><span class="line">function setScript(code, script) &#123;</span><br><span class="line">  let jsReg = /<span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">[\s|\S]*?<span class="xml"><span class="tag">&lt;<span class="name">\</span>/<span class="attr">script</span>&gt;</span></span><span class="regexp">/ig;</span></span></span><br><span class="line"><span class="javascript">  <span class="keyword">return</span> code.replace(jsReg, <span class="string">`&lt;script&gt;\n<span class="subst">$&#123;script&#125;</span></span></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span>`)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="需求分析"><a href="#需求分析" class="headerlink" title="需求分析"></a>需求分析</h3><p>上节只是简单的实现了代码的存取，重头戏终于来了。首先分析下我们要做什么。  </p>
<ul>
<li>拦截代码里的 <code>wx.navigateTo</code> 或 <code>wepy.navigateTo</code>，这两个api相同，开发者都可能调用 </li>
<li>将这个 api 的参数，由模版字符串，替换为 <code>qs.stringify</code> 方法调用  </li>
<li>如果该文件有替换操作，并且，文件头部没有 <code>import qs from &#39;qs&#39;</code>,需要手动加上  <h4 id="拦截api"><a href="#拦截api" class="headerlink" title="拦截api"></a>拦截api</h4>api 方法调用显然是一个 <code>ExpressionStatement</code>，因此我们很简单的拦截到了它，并且之后的操作都是在 <code>visitExpressionStatement</code> 回调里做的。<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">recast.visit(ast, &#123;</span><br><span class="line">  visitExpressionStatement: function(path) &#123;</span><br><span class="line">    const callee = path.node.expression.callee</span><br><span class="line">    if(!callee || !callee.object) &#123;</span><br><span class="line">      return false</span><br><span class="line">    &#125;</span><br><span class="line">    const objName = callee.object.name</span><br><span class="line">    const fnName = callee.property.name</span><br><span class="line">    // 调用者是wx 或者 wepy</span><br><span class="line">    if(objName === 'wx' || objName === 'wepy') &#123;</span><br><span class="line">      // 跳转</span><br><span class="line">      if(fnName === 'navigateTo') &#123;</span><br><span class="line">        // 拦截到了</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return false</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="模版字符串替换"><a href="#模版字符串替换" class="headerlink" title="模版字符串替换"></a>模版字符串替换</h4><p>悪夢の起源  </p>
<p>这里是核心功能，它消耗了我半天多时间。<br>我们位于以上代码 ‘拦截到了’ 位置。利用 devTool 找到了 wx.navigateTo 的语法树构成。<br>举个🌰：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wepy.navigateTo(&#123;</span><br><span class="line">  url: <span class="string">`/pages/detail/jobDetail?id=<span class="subst">$&#123;e.id&#125;</span>&amp;from=job_detail&amp;num=<span class="subst">$&#123;e.index&#125;</span>&amp;uniqueKey=<span class="subst">$&#123;uniqueKey&#125;</span>`</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">pre</span>&gt;</span></span><br><span class="line">if(fnName === 'navigateTo') &#123;</span><br><span class="line">  const argument = path.node.expression.arguments[0]</span><br><span class="line">  let &#123;expressions, quasis&#125; = argument.properties[0].value</span><br><span class="line">  if(!expressions || !quasis || !expressions.length) &#123;</span><br><span class="line">    return false</span><br><span class="line">  &#125;</span><br><span class="line">  if(expressions.length <span class="tag">&lt; <span class="attr">2</span>) &#123;<span class="attr">return</span> <span class="attr">false</span>&#125;</span></span><br><span class="line"><span class="tag">  <span class="attr">expressions</span> = <span class="string">expressions.map((val)</span> =&gt;</span> &#123;</span><br><span class="line">      const res = recast.print(val)</span><br><span class="line">      return res.code</span><br><span class="line">  &#125;)</span><br><span class="line">  let url = ''</span><br><span class="line">  quasis = quasis.map((val) =&gt; &#123;</span><br><span class="line">      const path = val.original.value.cooked</span><br><span class="line">      if(/\?/.test(path)) &#123;</span><br><span class="line">        // 把 url 存下来</span><br><span class="line">        url = path.split('?')[0]</span><br><span class="line">        return path.split('?')[1]</span><br><span class="line">      &#125;</span><br><span class="line">      return path</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">pre</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>事实上，ast将这行代码分割成了两组，一组是 expressions，一组是 quasis，我将这二者打印出来。前者是表达式，后者是字符串。正好 表达式长度 = 字符串长度 - 1。<br>这符合模版字符串的格式。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">"e.id"</span>, <span class="string">"e.index"</span>, <span class="string">"uniqueKey"</span>]</span><br><span class="line">[<span class="string">"id="</span>, <span class="string">"&amp;from=job_detail&amp;num="</span>, <span class="string">"&amp;uniqueKey="</span>, <span class="string">""</span>]</span><br></pre></td></tr></table></figure></p>
<p>我需要将这两个数组拼接起来，并给字符串加上引号。<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">pre</span>&gt;</span></span><br><span class="line"></span><br><span class="line">const express = assignArray(quasis, expressions).join('').split('&amp;')</span><br><span class="line">function assignArray(arr2, arr1) &#123;</span><br><span class="line">  // 把 arr2里面的字符串加上引号</span><br><span class="line">  arr2 = arr2.map((val) =&gt; val.split('&amp;').map((equel) =&gt; &#123;</span><br><span class="line">      if(!equel || !equel.split('=')[1]) &#123;</span><br><span class="line">        return equel</span><br><span class="line">      &#125;</span><br><span class="line">      const value = '\'' + equel.split('=')[1] + '\''</span><br><span class="line">      return [equel.split('=')[0], value].join('=')</span><br><span class="line">    &#125;).join('&amp;'))</span><br><span class="line">  arr1.forEach((item, index) =&gt; &#123;</span><br><span class="line">      arr2.splice(2 * (index + 1) - 1, 0, item)</span><br><span class="line">  &#125;)</span><br><span class="line">  return arr2</span><br><span class="line">&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">pre</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>最终是这个样子：<br><code>[&quot;id=e.id&quot;, &quot;from=&#39;job_detail&#39;&quot;, &quot;num=e.index&quot;, &quot;uniqueKey=uniqueKey&quot;]</code><br>接下来，将上面的数组转化成函数的参数即可<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">const</span> results = giveQsString(express, url)</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">giveQsString</span>(<span class="params">expressArr, url</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> str = <span class="string">`url: \`<span class="subst">$&#123;url&#125;</span>?\$&#123;qs.stringify(&#123;\n`</span></span><br><span class="line">  expressArr.map(<span class="function">(<span class="params">val, index</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> [key, value] = val.split(<span class="string">'='</span>)</span><br><span class="line">    <span class="keyword">if</span>(index === expressArr.length - <span class="number">1</span>)</span><br><span class="line">      str += <span class="string">`  <span class="subst">$&#123;key&#125;</span>: <span class="subst">$&#123;value&#125;</span>\n`</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      str += <span class="string">`  <span class="subst">$&#123;key&#125;</span>: <span class="subst">$&#123;value&#125;</span>,\n`</span></span><br><span class="line">  &#125;)</span><br><span class="line">  str += <span class="string">`&#125;)&#125;\``</span></span><br><span class="line">  <span class="built_in">console</span>.log(str)</span><br><span class="line">  <span class="keyword">return</span> str</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>最终是这个样子的。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">url: `/pages/detail/jobDetail?$&#123;qs.stringify(&#123;</span></span><br><span class="line"><span class="comment">  id: e.id,</span></span><br><span class="line"><span class="comment">  from: 'job_detail',</span></span><br><span class="line"><span class="comment">  num: e.index,</span></span><br><span class="line"><span class="comment">  uniqueKey: uniqueKey</span></span><br><span class="line"><span class="comment">&#125;)&#125;`</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure></p>
<p>最重要的一步，将该参数，填到 navigate 的方法中<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">path.node.expression.arguments[<span class="number">0</span>].properties[<span class="number">0</span>] = templateElement(&#123; </span><br><span class="line">  <span class="string">"cooked"</span>: results, <span class="string">"raw"</span>: results </span><br><span class="line">&#125;, <span class="literal">false</span>)</span><br></pre></td></tr></table></figure></p>
<p>就这样，核心的ast就完成了。</p>
<h4 id="加上-qs"><a href="#加上-qs" class="headerlink" title="加上 qs"></a>加上 qs</h4><p>如果该文件进行了以上步骤，那它就需要进行 import qs，这里只需要对 ImportDeclaration 进行判断，如果没有导入 qs 模块，则告诉下游，在文件头部追加 import 语句。<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">visitImportDeclaration: function(path) &#123;</span><br><span class="line">  // 如果模块引入了qs，则不需要导入</span><br><span class="line">  if(path.node.source.value === 'qs') &#123;</span><br><span class="line">    needQs = false</span><br><span class="line">  &#125;</span><br><span class="line">  return false</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>用我周报上的话来总结吧</p>
<blockquote>
<p>这周的两个需求都用上了AST，也是第一次将AST用在了实际项目中，两个需求产生的效果也不同。<br>jobmd_enum 代码结构和注释变更：这个库的代码文件格式比较统一，文件数较多，不太适合手动一个个改写，用AST做减少了不少时间，且难度不高<br>jobmd-weapp 路由参数走qs: 这个库的代码格式是wepy类型，做起来难度比较高，花了一整天的时间写AST代码，最终也实现了全局路由的替换，替换后发现需要替换的文件并不多，所以这是一个反例。<br>因此，在决定用AST前一定要先调研是否适合用，我认为需要满足以下两个条件:<br>1，ast 代码容易写。 2，重复的工作量大</p>
</blockquote>

        </section>
    </article>
    
        
  </div>
  <aside>
    
    <div class="toc-container">
        <h1>目录</h1>
        <div class="content">
            <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#AST-和-我"><span class="toc-number">1.</span> <span class="toc-text">AST 和 我</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#枚举库-和-JSDOC-的碰撞"><span class="toc-number">2.</span> <span class="toc-text">枚举库 和 JSDOC 的碰撞</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#你为什么不问问神奇的-AST-呢"><span class="toc-number">2.1.</span> <span class="toc-text">你为什么不问问神奇的 AST 呢</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#又一个需求"><span class="toc-number">3.</span> <span class="toc-text">又一个需求</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#小程序路由参数修改"><span class="toc-number">3.1.</span> <span class="toc-text">小程序路由参数修改</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#再问问神奇的-AST-？"><span class="toc-number">3.2.</span> <span class="toc-text">再问问神奇的 AST ？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#需求分析"><span class="toc-number">3.3.</span> <span class="toc-text">需求分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#拦截api"><span class="toc-number">3.3.1.</span> <span class="toc-text">拦截api</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#模版字符串替换"><span class="toc-number">3.3.2.</span> <span class="toc-text">模版字符串替换</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#加上-qs"><span class="toc-number">3.3.3.</span> <span class="toc-text">加上 qs</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-number">4.</span> <span class="toc-text">总结</span></a></li></ol>
        </div>
    </div>
    
  </aside>
</main>



  <footer>
  <div class="copyright">
    <div>
      &copy; 2021 | Powered by <a href="https://hexo.io" target="_blank">Hexo</a>&nbsp
    </div>
    <div>
      Theme by <a href="https://github.com/lewis-geek/hexo-theme-Aath" target="_blank">Aath</a>
    </div>
  </div>
</footer>


<script src="https://cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
<script src="/lib/in-view.min.js"></script>
<script src="/lib/lodash.min.js"></script>
<script>
  var isDown = true
  var oldY = 0
  inView.offset(50)

  document.body.addEventListener('touchstart', function(){});
  
  window.addEventListener('scroll', _.throttle(e => {
    var currentY = window.scrollY
    if((oldY - currentY) < 0) {
      isDown = true
    } else {
      isDown = false
    }
    oldY = currentY
  }, 250))

  $("article img").each(function() {
      var strA = "<a data-fancybox='gallery' href='" + this.src + "'></a>";
      $(this).wrapAll(strA);
  });

  $('.toc-link').each(function() {
      var href = $(this).attr("href");
      
      inView(href).on('exit', () => {
        if (isDown) {
          handleActive(href)
        }
      })

      inView(href).on('enter', () => {
        if (!isDown) {
          handleActive(href)
        }
      })

      this.onclick = function(e) {
        var pos = $(href).offset().top - 10;
        $("html,body").animate({scrollTop: pos}, 300);
        setTimeout(() => {
          handleActive(href)
        }, 350)
        return false
      }
  })

  function handleActive(href) {
    document.querySelectorAll('.toc-link').forEach(elm => {
      elm.classList.remove('active')
    })
    document.querySelector(".toc [href='"+ href +"']").classList.add('active')
  }
</script>
<script src="/lib/jquery.fancybox.min.js"></script>


</body>
</html>
